# MySQLチューニング

まず、最初にMySQLに限らず、負荷対策やチューニングするときは現在の状態を確認すること。
`推測するな、計測せよ`という言葉で表されてる通り、現在の状態を正しく把握し、何がボトルネックになっているのか、
正しく判断し、対処することが肝要です。

チューニングには終わりが無く、いくらでもやれるのでどこがゴールなのかをあらかじめ決めておくとよいでしょう。
一定以上チューニングすると費用対効果が悪くなるので、引き際を見極めるのが大事です。

## 負荷をみる

現在の状態を見るために何はともあれ現在の負荷を確認します。

- ボトルネックになっているミドルウェアはどこか
- CPUバウンドなのか IOバウンドなのか

### 現在のスナップショットを見る


```sh
# ロードアベレージを見る
w
# プロセスを見る
ps -ef
# メモリを使ってるプロセスを見る
ps --sort=-%mem auxwww | head
# CPU使ってるプロセスを見る
ps --sort=-%cpu auxwww | head
```

現在実行中のクエリを見ることができます。

```sql
SHOW FULL PROCESSLIST;
```

### 継続的に現在の状態を見る

```sh
top
dstat -tamsl 5
mpstat -P ALL 5
```

### 過去の統計を見る

`sysstat`が入っていれば、`sar`コマンドで過去の負荷統計を確認することができます。

```sh
# CPU
sar -C
# Memry
sar -r
# Load average
sar -q
```

過去の統計情報は[Cloudforecast](https://github.com/kazeburo/cloudforecast)などのグラフツールでリソース監視していると思うので、そちらを見てもよいです。

## ログを仕込む

なんか負荷が高そうという現状が分かっても、具体的に何が原因なのかはアプリを分析してみないと分かりません。
アプリケーションのボトルネックなってそうな部分を分析するためのいくつかの手段を紹介します。

### アクセスログに処理時間を出力するようにする

アプリケーションサーバのアクセスログにruntimeを出すようにしてどのパスで時間がかかってるのか集計出来るようにします。

### アプリケーションにプロファイラーを仕込む

プロファイラーを仕込んでどの処理に時間がかかってるのか分かるようにします。perlなら[Devel::KYTProf](https://metacpan.org/pod/Devel::KYTProf)や[Devel::NYTProf](https://metacpan.org/pod/Devel::NYTProf)など。

※プロファイラーを仕込むとアプリケーションの速度が遅くなるので、本番に仕込むときはよく考えましょう。

### MySQLのスロークエリログを出力するようにする

オンラインで有効にするには以下のようにします。

```sql
SET GROBAL slow_query_log=ON;
SET GROBAL logn_query_time=0.1;
```

以下のようにmy.cnfに書いて、mysqldを再起動して反映させてもよいです。

```
[mysqld]
# 中略
slow_query_log=ON
logn_query_time=0.1

```

インデックスが使われてないクエリを全部みたい場合、下記の設定も有効でしょう

```
[mysqld]
# 中略
log_queries_not_using_indexes
```

吐かれたログは`mysqldumpslow`で解析することができます。

```sh
mysqldumpslow /var/log/slow-log
```

## チューニングの勘所

### アプリケーションコードの問題

- 無駄にクエリを発行している
    - 同じ処理内で複数回発行してるのであれば、1つにまとめる
    - キャッシュを利用出来ないか検討する
- ループ内でクエリを発行してる
    - JOINで代用出来ないか検討する
    - またはループの外でクエリを発行してアプリケーション
- テンプレートエンジン内の処理でクエリを発行してる
    - 気づきにくいので避ける

### クエリの問題

- LIMITが無いクエリ/取得行数が多い
- 不要なカラムを選択してる
- インデックスが適切使われてないクエリ

### インデックスの問題

- 不必要なインデックス
    - データサイズが無駄に大きくなる
    - 更新速度が遅くなる

## EXPLAIN

## InnoDBのインデックス

## リソース

- 書籍
    - [実践ハイパフォーマンスMySQL 第3版](http://www.amazon.co.jp/dp/4873116384)
    - [エキスパートのためのMySQL[運用+管理]トラブルシューティングガイド](http://www.amazon.co.jp/dp/4774142948)
    - [SQLアンチパターン ](http://www.amazon.co.jp/dp/4873115892/)
    - [MySQLトラブルシューティング](http://www.amazon.co.jp/dp/4873115868/)
